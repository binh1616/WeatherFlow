version: '3.8'  # Giữ nguyên, warning là bình thường (Docker Compose mới ignore version)

services:
  kafka:
    image: confluentinc/cp-kafka:7.8.0   # or :latest; 7.8 is stable in 2026
    container_name: kafka
    ports:
      - "9092:9092"
      - "9094:9094"  # optional external
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093,PLAINTEXT_HOST://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3
      CLUSTER_ID: 4L6g3nShT-eMCtK--X86sw   # must match if reusing data
    volumes:
      - ./kafka-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 > /dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 45s   # Give more time for KRaft format + startup
    networks:
      - flink-net
  python-service:
    depends_on:
      kafka:
        condition: service_healthy
      mysql:
        condition: service_healthy
    build: 
      context: .
      dockerfile: dockerfile.python
    volumes:
      - ./app:/app/python_code  # Mount thư mục host vào container để edit code realtime (dev mode)
    environment:
      - PYTHONUNBUFFERED=1  # Để log realtime
    command: ["/bin/bash", "-c", "source /opt/venv/bin/activate && python python_code/init_flink_mysql.py && python python_code/create_topics.py && (python python_code/api_weather.py & python python_code/api_alert.py) && tail -f /dev/null"]    
    networks:
      - flink-net
  mysql:
    # Giữ nguyên như cũ
    image: mysql:8.0
    container_name: mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: flink_db
      MYSQL_USER: flink
      MYSQL_PASSWORD: flink
    volumes:
      - ./mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "--password=root"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - flink-net
  flink-python:
    depends_on:
      kafka:
        condition: service_healthy
      mysql:
        condition: service_healthy
    build:
      context: .
      dockerfile: dockerfile.flink-python
    container_name: flink-python
    volumes:
      - ./app:/app
    command: ["/bin/bash","-c","echo 'Waiting 5 minutes...'; sleep 100 && source /opt/venv/bin/activate && (flink run -m jobmanager:8081 -py cdc_flink.py & flink run -m jobmanager:8081 -py alerts_pipeline.py & flink run -m jobmanager:8081 -py pyflink_weather_avg.py) & tail -f /dev/null"]
    networks:
      - flink-net

  jobmanager:
    build:
      context: .
      dockerfile: dockerfile.flink-python
    container_name: flink-jobmanager
    ports:
      - "8081:8081"
      - "6123:6123"
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 2
        parallelism.default: 2
    volumes:
      - ./flink-checkpoint:/opt/flink/checkpoint
      - ./flink-usrlib:/opt/flink/usrlib
      - ./flink-lib:/opt/flink/usrlib/connectors
    depends_on:
      kafka:
        condition: service_healthy
      mysql:
        condition: service_healthy
    networks:
      - flink-net

  taskmanager:
    # Giữ nguyên, scale: 2
    build:
      context: .
      dockerfile: dockerfile.flink-python
    depends_on:
      - jobmanager
    command: taskmanager
    scale: 2
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 2
        parallelism.default: 2
    volumes:
      - ./flink-checkpoint:/opt/flink/checkpoint
      - ./flink-usrlib:/opt/flink/usrlib
      - ./flink-lib:/opt/flink/usrlib/connectors
    networks:
      - flink-net

networks:
  flink-net:
    driver: bridge